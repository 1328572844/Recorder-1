/*
录音
https://github.com/xiangyuecn/Recorder
src: recorder-core.js
*/
!function(l){"use strict";h.LM="2019-9-9 21:09:34";var m=function(){};function h(e){return new t(e)}function t(e){var t={type:"mp3",bitRate:16,sampleRate:16e3,bufferSize:4096,onProcess:m};for(var a in e)t[a]=e[a];this.set=t,this._S=9}h.IsOpen=function(){var e=h.Stream;if(e){var t=e.getTracks();if(0<t.length)return"live"==t[0].readyState}return!1},h.Support=function(){var e=l.AudioContext;if(e||(e=l.webkitAudioContext),!e)return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(h.Scope=t,h.Ctx&&"closed"!=h.Ctx.state||(h.Ctx=new e),!0)},h.SampleData=function(e,t,a,n){n||(n={});for(var o=n.index||0,r=n.offset||0,s=0,i=o;i<e.length;i++)s+=e[i].length;s=Math.max(0,s-Math.floor(r));var c=t/a;1<c?s=Math.floor(s/c):(c=1,a=t);for(var p=new Int16Array(s),f=0,u=e.length;o<u;o++){for(var l=e[o],m=(i=r,l.length);i<m;){var h=Math.floor(i),v=Math.ceil(i),S=i-h;p[f]=l[h]+(l[v]-l[h])*S,f++,i+=c}r=i-m}return{index:o,offset:r,sampleRate:a,data:p}},h.Sync={O:9,C:9},h.prototype=t.prototype={open:function(e,a){var t=this;e=e||m,a=a||m;var n=function(){e(),t._SO=0},o=function(e,t){/Permission|Allow/i.test(e)?a("用户拒绝了录音权限",!0):!1===l.isSecureContext?a("无权录音(需https)"):/Found/i.test(e)?a(t+"，无可用麦克风"):a(t)},r=h.Sync,s=++r.O,i=r.C;t._O=t._O_=s,t._SO=t._S;var c=function(){if(i!=r.C||!t._O){var e="open被取消";return s==r.O?t.close():e="open被中断",a(e),!0}};if(h.IsOpen())n();else if(h.Support()){var p=function(e){h.Stream=e,c()||setTimeout(function(){c()||(h.IsOpen()?n():a("录音功能无效：无音频流"))},100)},f=function(e){var t=e.name||e.message||e.code+":"+e;console.error(e),o(t,"无法录音："+t)},u=h.Scope.getUserMedia({audio:!0},p,f);u&&u.then&&u.then(p)[e&&"catch"](f)}else o("","此浏览器不支持录音")},close:function(e){e=e||m;var t=this;t._stop();var a=h.Sync;if(t._O=0,t._O_!=a.O)return console.warn("close被忽略"),void e();a.C++;var n=h.Stream;if(n)for(var o=n.getTracks(),r=0;r<o.length;r++)o[r].stop();h.Stream=0,e()},mock:function(e,t){var a=this;return a._stop(),a.isMock=1,a.buffers=[e],a.recSize=e.length,a.srcSampleRate=t,a},envStart:function(e,t){var a=this,n=a.set;if(a.isMock=e?1:0,a.buffers=[],a.recSize=0,n.sampleRate=Math.min(t,n.sampleRate),a.srcSampleRate=t,a.engineCtx=0,a[n.type+"_start"]){var o=a.engineCtx=a[n.type+"_start"](n);o&&(o.pcmDatas=[],o.pcmSize=0)}},envIn:function(e,t){var a=this,n=a.set,o=a.engineCtx,r=e.length;a.recSize+=r;var s=a.buffers;s.push(e);var i,c=t/r;i=c<1251?Math.round(c/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(c/1e4)/Math.log(10)))));var p=a.srcSampleRate,f=a.recSize;if(o){var u=h.SampleData(s,p,n.sampleRate,o.chunkInfo);o.chunkInfo=u,o.pcmSize+=u.data.length,f=o.pcmSize,(s=o.pcmDatas).push(u.data),p=u.sampleRate,a[n.type+"_encode"](o,u.data)}var l=Math.round(f/p*1e3);n.onProcess(s,i,l,p)},start:function(){if(h.IsOpen()){console.log("["+Date.now()+"]Start");var e=this,t=(e.set,h.Ctx);e._stop(),e.state=0,e.envStart(0,t.sampleRate),e._SO&&e._SO+1!=e._S?console.warn("start被中断"):(e._SO=0,"suspended"==t.state?t.resume().then(function(){console.log("ctx resume"),e._start()}):e._start())}else console.error("未open")},_start:function(){var i=this,e=i.set,t=(i.engineCtx,h.Ctx),a=i.media=t.createMediaStreamSource(h.Stream),n=i.process=(t.createScriptProcessor||t.createJavaScriptNode).call(t,e.bufferSize,1,1);n.onaudioprocess=function(e){if(1==i.state){for(var t=e.inputBuffer.getChannelData(0),a=t.length,n=new Int16Array(a),o=0,r=0;r<a;r++){var s=Math.max(-1,Math.min(1,t[r]));s=s<0?32768*s:32767*s,n[r]=s,o+=Math.abs(s)}i.envIn(n,o)}},a.connect(n),n.connect(t.destination),i.state=1},pause:function(e){this.state&&(this.state=e||2)},resume:function(){this.pause(1)},_stop:function(e){var t=this,a=t.set;t.isMock||t._S++,t.state&&(t.state=0,t.media.disconnect(),t.process.disconnect()),!e&&t[a.type+"_stop"]&&(t[a.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(a,t,e){console.log("["+Date.now()+"]Stop");var n,o=this,r=o.set,s=function(){o._stop(),e&&o.close()},i=function(e){t&&t(e),s()},c=function(e,t){console.log("["+Date.now()+"]End "+t+"ms 编码花:"+(Date.now()-n)+"ms "+e.size+"b"),e.size<Math.max(100,t/2)?i("生成的"+r.type+"无效"):(a&&a(e,t),s())};if(!o.isMock){if(!o.state)return void i("未开始录音");o._stop(!0)}var p=o.recSize;if(p)if(o[r.type]){var f=o.engineCtx;if(o[r.type+"_complete"]&&f){f.pcmDatas;var u=Math.round(f.pcmSize/r.sampleRate*1e3);return n=Date.now(),void o[r.type+"_complete"](f,function(e){c(e,u)},i)}n=Date.now();var l=h.SampleData(o.buffers,o.srcSampleRate,r.sampleRate);r.sampleRate=l.sampleRate;var m=l.data;u=Math.round(m.length/r.sampleRate*1e3);console.log("采样"+p+"->"+m.length+" 花:"+(Date.now()-n)+"ms"),setTimeout(function(){n=Date.now(),o[r.type](m,function(e){c(e,u)},function(e){i(e)})})}else i("未加载"+r.type+"编码器");else i("未采集到录音")}},l.Recorder=h}(window);