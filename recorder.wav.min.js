/*
录音
https://github.com/xiangyuecn/Recorder
src: recorder-core.js,engine/wav.js
*/
!function(v){"use strict";R.LM="2019-10-26 11:23:58";var l=function(){};function R(e){return new t(e)}function t(e){var t={type:"mp3",bitRate:16,sampleRate:16e3,bufferSize:4096,onProcess:l};for(var n in e)t[n]=e[n];this.set=t,this._S=9}R.IsOpen=function(){var e=R.Stream;if(e){var t=e.getTracks();if(0<t.length)return"live"==t[0].readyState}return!1},R.Support=function(){var e=v.AudioContext;if(e||(e=v.webkitAudioContext),!e)return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(R.Scope=t,R.Ctx&&"closed"!=R.Ctx.state||(R.Ctx=new e),!0)},R.SampleData=function(e,t,n,a){a||(a={});for(var r=a.index||0,s=a.offset||0,o=0,i=r;i<e.length;i++)o+=e[i].length;o=Math.max(0,o-Math.floor(s));var c=t/n;1<c?o=Math.floor(o/c):(c=1,n=t);for(var f=new Int16Array(o),u=0,p=e.length;r<p;r++){for(var v=e[r],l=(i=s,v.length);i<l;){var h=Math.floor(i),m=Math.ceil(i),d=i-h;f[u]=v[h]+(v[m]-v[h])*d,u++,i+=c}s=i-l}return{index:r,offset:s,sampleRate:n,data:f}},R.Sync={O:9,C:9},R.prototype=t.prototype={open:function(e,n){var t=this;e=e||l,n=n||l;var a=function(){e(),t._SO=0},r=function(e,t){/Permission|Allow/i.test(e)?n("用户拒绝了录音权限",!0):!1===v.isSecureContext?n("无权录音(需https)"):/Found/i.test(e)?n(t+"，无可用麦克风"):n(t)},s=R.Sync,o=++s.O,i=s.C;t._O=t._O_=o,t._SO=t._S;var c=function(){if(i!=s.C||!t._O){var e="open被取消";return o==s.O?t.close():e="open被中断",n(e),!0}};if(R.IsOpen())a();else if(R.Support()){var f=function(e){R.Stream=e,c()||setTimeout(function(){c()||(R.IsOpen()?a():n("录音功能无效：无音频流"))},100)},u=function(e){var t=e.name||e.message||e.code+":"+e;console.error(e),r(t,"无法录音："+t)},p=R.Scope.getUserMedia({audio:!0},f,u);p&&p.then&&p.then(f)[e&&"catch"](u)}else r("","此浏览器不支持录音")},close:function(e){e=e||l;var t=this;t._stop();var n=R.Sync;if(t._O=0,t._O_!=n.O)return console.warn("close被忽略"),void e();n.C++;var a=R.Stream;if(a)for(var r=a.getTracks(),s=0;s<r.length;s++)r[s].stop();R.Stream=0,e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.buffers=[e],n.recSize=e.length,n.srcSampleRate=t,n},envStart:function(e,t){var n=this,a=n.set;if(n.isMock=e?1:0,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],a.sampleRate=Math.min(t,a.sampleRate),n.srcSampleRate=t,n.engineCtx=0,n[a.type+"_start"]){var r=n.engineCtx=n[a.type+"_start"](a);r&&(r.pcmDatas=[],r.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var n=this,a=n.set,r=n.engineCtx,s=e.length;n.recSize+=s;var o=n.buffers;o.push(e);var i,c=t/s;i=c<1251?Math.round(c/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(c/1e4)/Math.log(10)))));var f=n.srcSampleRate,u=n.recSize,p=Date.now(),v=Math.round(s/f*1e3);n.envInLast=p,1==n.buffers.length&&(n.envInFirst=p-v);var l=n.envInFixTs;l.splice(0,0,{t:p,d:v});for(var h=p,m=0,d=0;d<l.length;d++){var S=l[d];if(3e3<p-S.t){l.length=d;break}h=S.t,m+=S.d}var g=l[1],M=p-h;if(M/3<M-m&&(g&&1e3<M||6<=l.length)){var _=p-g.t-v;if(v/5<_){var w=!a.disableEnvInFix;if(console.warn("["+p+"]"+(w?"":"未")+"补偿"+_+"ms"),n.envInFix+=_,w){var x=new Int16Array(_*f/1e3);n.recSize+=x.length,o.push(x)}}}if(r){var I=R.SampleData(o,f,a.sampleRate,r.chunkInfo);r.chunkInfo=I,r.pcmSize+=I.data.length,u=r.pcmSize,(o=r.pcmDatas).push(I.data),f=I.sampleRate,n[a.type+"_encode"](r,I.data)}var y=Math.round(u/f*1e3);a.onProcess(o,i,y,f)},start:function(){if(R.IsOpen()){console.log("["+Date.now()+"]Start");var e=this,t=(e.set,R.Ctx);e._stop(),e.state=0,e.envStart(0,t.sampleRate),e._SO&&e._SO+1!=e._S?console.warn("start被中断"):(e._SO=0,"suspended"==t.state?t.resume().then(function(){console.log("ctx resume"),e._start()}):e._start())}else console.error("未open")},_start:function(){var i=this,e=i.set,t=(i.engineCtx,R.Ctx),n=i.media=t.createMediaStreamSource(R.Stream),a=i.process=(t.createScriptProcessor||t.createJavaScriptNode).call(t,e.bufferSize,1,1);a.onaudioprocess=function(e){if(1==i.state){for(var t=e.inputBuffer.getChannelData(0),n=t.length,a=new Int16Array(n),r=0,s=0;s<n;s++){var o=Math.max(-1,Math.min(1,t[s]));o=o<0?32768*o:32767*o,a[s]=o,r+=Math.abs(o)}i.envIn(a,r)}},n.connect(a),a.connect(t.destination),i.state=1},pause:function(e){this.state&&(this.state=e||2)},resume:function(){this.pause(1),this.envResume()},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.state=0,t.media.disconnect(),t.process.disconnect()),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(n,t,e){var a,r=this,s=r.set;console.log("["+Date.now()+"]Stop "+(r.envInLast?r.envInLast-r.envInFirst+"ms 补"+r.envInFix+"ms":"-"));var o=function(){r._stop(),e&&r.close()},i=function(e){t&&t(e),o()},c=function(e,t){console.log("["+Date.now()+"]结束 编码"+(Date.now()-a)+"ms 音频"+t+"ms/"+e.size+"b"),e.size<Math.max(100,t/2)?i("生成的"+s.type+"无效"):(n&&n(e,t),o())};if(!r.isMock){if(!r.state)return void i("未开始录音");r._stop(!0)}var f=r.recSize;if(f)if(r.buffers[0])if(r[s.type]){var u=r.engineCtx;if(r[s.type+"_complete"]&&u){u.pcmDatas;var p=Math.round(u.pcmSize/s.sampleRate*1e3);return a=Date.now(),void r[s.type+"_complete"](u,function(e){c(e,p)},i)}a=Date.now();var v=R.SampleData(r.buffers,r.srcSampleRate,s.sampleRate);s.sampleRate=v.sampleRate;var l=v.data;p=Math.round(l.length/s.sampleRate*1e3);console.log("采样"+f+"->"+l.length+" 花:"+(Date.now()-a)+"ms"),setTimeout(function(){a=Date.now(),r[s.type](l,function(e){c(e,p)},function(e){i(e)})})}else i("未加载"+s.type+"编码器");else i("音频被释放");else i("未采集到录音")}},v.Recorder=R}(window),function(){"use strict";Recorder.prototype.enc_wav={stable:!0,testmsg:"比特率取值范围8位、16位"},Recorder.prototype.wav=function(e,t,n){var a=this.set,r=e.length,s=a.sampleRate,o=8==a.bitRate?8:16,i=r*(o/8),c=new ArrayBuffer(44+i),f=new DataView(c),u=0,p=function(e){for(var t=0;t<e.length;t++,u++)f.setUint8(u,e.charCodeAt(t))},v=function(e){f.setUint16(u,e,!0),u+=2},l=function(e){f.setUint32(u,e,!0),u+=4};if(p("RIFF"),l(36+i),p("WAVE"),p("fmt "),l(16),v(1),v(1),l(s),l(s*(o/8)),v(o/8),v(o),p("data"),l(i),8==o)for(var h=0;h<r;h++,u++){var m=128+(e[h]>>8);f.setInt8(u,m,!0)}else for(h=0;h<r;h++,u+=2)f.setInt16(u,e[h],!0);t(new Blob([f.buffer],{type:"audio/wav"}))}}();