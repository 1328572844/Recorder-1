/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/frequency.histogram.view.js
*/
!function(){"use strict";var t=function(t){return new e(t)},e=function(t){var e=this,r={scale:2,fps:20,lineCount:30,lineWidth:6,minHeight:0,position:-1,stripeEnable:!0,stripeHeight:3,stripeMargin:6,fallDuration:1e3,stripeFallDuration:3500,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeLinear:null,shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(t,e){}};for(var a in t)r[a]=t[a];e.set=t=r;var i=t.elem;i&&("string"==typeof i?i=document.querySelector(i):i.length&&(i=i[0])),i&&(t.width=i.offsetWidth,t.height=i.offsetHeight);var o=t.scale,l=t.width*o,n=t.height*o,h=e.elem=document.createElement("div"),s=["","transform-origin:0 0;","transform:scale("+1/o+");"];h.innerHTML='<div style="width:'+t.width+"px;height:"+t.height+'px;overflow:hidden"><div style="width:'+l+"px;height:"+n+"px;"+s.join("-webkit-")+s.join("-ms-")+s.join("-moz-")+s.join("")+'"><canvas/></div></div>';var f=e.canvas=h.querySelector("canvas");e.ctx=f.getContext("2d");if(f.width=l,f.height=n,i&&(i.innerHTML="",i.appendChild(h)),!Recorder.LibFFT)throw new Error("需要lib.fft.js支持");e.fft=Recorder.LibFFT(1024),e.lastH=[],e.stripesH=[]};e.prototype=t.prototype={genLinear:function(t,e,r,a){for(var i=t.createLinearGradient(0,r,0,a),o=0;o<e.length;)i.addColorStop(e[o++],e[o++]);return i},input:function(t,e,r){var a=this;a.sampleRate=r,a.pcmData=t,a.pcmPos=0,a.inputTime=Date.now(),a.schedule()},schedule:function(){var t=this,e=t.set,r=Math.floor(1e3/e.fps);t.timer||(t.timer=setInterval(function(){t.schedule()},r));var a=Date.now(),i=t.drawTime||0;if(a-t.inputTime>1.3*e.stripeFallDuration)return clearInterval(t.timer),void(t.timer=0);if(!(a-i<r)){t.drawTime=a;for(var o=t.fft.bufferSize,l=t.pcmData,n=t.pcmPos,h=new Int16Array(o),s=0;s<o&&n<l.length;s++,n++)h[s]=l[n];t.pcmPos=n;var f=t.fft.transform(h);t.draw(f,t.sampleRate)}},draw:function(t,e){var r=this,a=r.set,i=r.ctx,o=a.scale,l=a.width*o,n=a.height*o,h=a.lineCount,s=r.fft.bufferSize,f=a.position,d=Math.abs(a.position),p=1==f?0:n,c=n;d<1&&(p=c/=2,c=Math.floor(c*(1+d)),p=Math.floor(0<f?p*(1-d):p*(1+d)));for(var u=r.lastH,g=r.stripesH,v=Math.ceil(c/(a.fallDuration/(1e3/a.fps))),w=Math.ceil(c/(a.stripeFallDuration/(1e3/a.fps))),m=a.stripeMargin*o,M=1<<(Math.round(Math.log(s)/Math.log(2)+3)<<1),b=Math.log(M)/Math.log(10),L=20*Math.log(32767)/Math.log(10),y=s/2,S=Math.floor(1e4*y/e),C=Math.round(.8*h),H=S/C,D=(y-S)/(h-C),x=0,R=0;R<h;R++){var F=Math.ceil(x);x+=R<C?H:D;for(var T=Math.floor(x),B=0,j=F;j<T;j++)B=Math.max(B,Math.abs(t[j]));var E=M<B?Math.floor(17*(Math.log(B)/Math.log(10)-b)):0,q=c*Math.min(E/L,1);u[R]=(u[R]||0)-v,q<u[R]&&(q=u[R]),q<0&&(q=0),u[R]=q;var z=g[R]||0;if(q&&z<q+m)g[R]=q+m;else{var I=z-w;I<0&&(I=0),g[R]=I}}i.clearRect(0,0,l,n);var P=r.genLinear(i,a.linear,p,p-c),W=a.stripeLinear&&r.genLinear(i,a.stripeLinear,p,p-c)||P,k=r.genLinear(i,a.linear,p,p+c),A=a.stripeLinear&&r.genLinear(i,a.stripeLinear,p,p+c)||k;i.shadowBlur=a.shadowBlur*o,i.shadowColor=a.shadowColor;var G=a.lineWidth*o;l<G*h+(h+1)*o&&(G=Math.max(1*o,Math.floor((l-(h+1)*o)/h)));for(var V=(l-h*G)/(h+1),J=a.minHeight*o,K=(R=0,0);R<h;R++)K+=V,O=Math.floor(K),q=Math.max(u[R],J),0!=p&&(Q=p-q,i.fillStyle=P,i.fillRect(O,Q,G,q)),p!=n&&(i.fillStyle=k,i.fillRect(O,p,G,q)),K+=G;if(a.stripeEnable){var N=a.stripeShadowBlur;i.shadowBlur=(-1==N?a.shadowBlur:N)*o,i.shadowColor=a.stripeShadowColor||a.shadowColor;var O,Q,U=a.stripeHeight*o;for(R=0,K=0;R<h;R++)K+=V,O=Math.floor(K),q=g[R],0!=p&&((Q=p-q-U)<0&&(Q=0),i.fillStyle=W,i.fillRect(O,Q,G,U)),p!=n&&(n<(Q=p+q)+U&&(Q=n-U),i.fillStyle=A,i.fillRect(O,Q,G,U)),K+=G}a.onDraw(t)}},Recorder.FrequencyHistogramView=t}();