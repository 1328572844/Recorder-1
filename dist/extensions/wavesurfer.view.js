/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/wavesurfer.view.js
*/
!function(){"use strict";var e=function(e){return new t(e)},t=function(e){var t=this,a={scale:2,fps:50,duration:2500,direction:1,position:0,centerHeight:1,linear:[0,"rgba(0,187,17,1)",.7,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],lineColor:""};for(var r in e)a[r]=e[r];t.set=e=a;var i=e.elem;i&&("string"==typeof i?i=document.querySelector(i):i.length&&(i=i[0])),i&&(e.width=i.offsetWidth,e.height=i.offsetHeight);var n=e.scale,o=e.width*n,l=e.height*n,h=t.elem=document.createElement("div"),c=["","transform-origin:0 0;","transform:scale("+1/n+");"];h.innerHTML='<div style="width:'+e.width+"px;height:"+e.height+'px;overflow:hidden"><div style="width:'+o+"px;height:"+l+"px;"+c.join("-webkit-")+c.join("-ms-")+c.join("-moz-")+c.join("")+'"><canvas/></div></div>';var s=t.canvas=h.querySelector("canvas");t.ctx=s.getContext("2d");s.width=o,s.height=l;var d=t.canvas2=document.createElement("canvas");t.ctx2=d.getContext("2d");d.width=2*o,d.height=l,i&&(i.innerHTML="",i.appendChild(h)),t.x=0};t.prototype=e.prototype={genLinear:function(e,t,a,r){for(var i=e.createLinearGradient(0,a,0,r),n=0;n<t.length;)i.addColorStop(t[n++],t[n++]);return i},input:function(e,t,a){var r=this;r.sampleRate=a,r.pcmData=e,r.pcmPos=0,r.inputTime=Date.now(),r.schedule()},schedule:function(){var e=this,t=e.set,a=Math.floor(1e3/t.fps);e.timer||(e.timer=setInterval(function(){e.schedule()},a));var r=Date.now();if(!(r-(e.drawTime||0)<a)){e.drawTime=r;for(var i=e.sampleRate/t.fps,n=e.pcmData,o=e.pcmPos,l=new Int16Array(Math.min(i,n.length-o)),h=0;h<l.length;h++,o++)l[h]=n[o];e.pcmPos=o,l.length?e.draw(l,e.sampleRate):1.3<r-e.inputTime&&(clearInterval(e.timer),e.timer=0)}},draw:function(e,t){var a=this,r=a.set,i=a.ctx2,n=r.scale,o=r.width*n,l=2*o,h=r.height*n,c=1*n,s=r.position,d=Math.abs(r.position),f=1==s?0:h,v=h;d<1&&(f=v/=2,v=Math.floor(v*(1+d)),f=Math.floor(0<s?f*(1-d):f*(1+d)));for(var m=1e3*e.length/t,g=Math.floor(m*o/r.duration),p=Math.floor(g/c),u=a.genLinear(i,r.linear,f,f-v),w=a.genLinear(i,r.linear,f,f+v),M=a.x,x=e.length/p,y=0,R=0;y<p;y++){var S=Math.floor(R),b=Math.floor(R+x);R+=x;for(var C=0;S<b;S++)C=Math.max(C,Math.abs(e[S]));var I=v*Math.min(1,C/32767);0!=f&&(i.fillStyle=u,i.fillRect(M,f-I,c,I)),f!=h&&(i.fillStyle=w,i.fillRect(M,f,c,I)),l<=(M+=c)&&(i.clearRect(0,0,o,h),i.drawImage(a.canvas2,o,0,o,h,0,0,o,h),i.clearRect(o,0,o,h),M=o)}a.x=M,(i=a.ctx).clearRect(0,0,o,h);var L=r.centerHeight*n;if(L){var T=f-Math.floor(L/2);T=Math.max(T,0),T=Math.min(T,h-L),i.fillStyle=r.lineColor||r.linear[1],i.fillRect(0,T,o,L)}var H=0,j=M,D=0;o<j?(H=j-o,j=o):D=o-j,-1==r.direction?i.drawImage(a.canvas2,H,0,j,h,D,0,j,h):(i.save(),i.scale(-1,1),i.drawImage(a.canvas2,H,0,j,h,-o+D,0,j,h),i.restore())}},Recorder.WaveSurferView=e}();