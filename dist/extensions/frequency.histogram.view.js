/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/frequency.histogram.view.js
*/
!function(){"use strict";var t=function(t){return new e(t)},e=function(t){var e=this,r={scale:2,fps:20,lineCount:15,lineWidth:10,minHeight:0,position:-1,stripeEnable:!0,stripeHeight:5,stripeMargin:8,fallDuration:600,stripeFallDuration:1200,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeColor:"",shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(t,e){}};for(var a in t)r[a]=t[a];e.set=t=r;var i=t.elem;i&&("string"==typeof i?i=document.querySelector(i):i.length&&(i=i[0])),i&&(t.width=i.offsetWidth,t.height=i.offsetHeight);var o=t.scale,l=t.width*o,n=t.height*o,h=e.elem=document.createElement("div"),s=["","transform-origin:0 0;","transform:scale("+1/o+");"];h.innerHTML='<div style="width:'+t.width+"px;height:"+t.height+'px;overflow:hidden"><div style="width:'+l+"px;height:"+n+"px;"+s.join("-webkit-")+s.join("-ms-")+s.join("-moz-")+s.join("")+'"><canvas/></div></div>';var f=e.canvas=h.querySelector("canvas");e.ctx=f.getContext("2d");if(f.width=l,f.height=n,i&&(i.innerHTML="",i.appendChild(h)),!Recorder.LibFFT)throw new Error("需要lib.fft.js支持");e.fft=Recorder.LibFFT(1024),e.lastH=[],e.stripesH=[]};e.prototype=t.prototype={genLinear:function(t,e,r,a){for(var i=t.createLinearGradient(0,r,0,a),o=0;o<e.length;)i.addColorStop(e[o++],e[o++]);return i},input:function(t,e,r){var a=this;a.sampleRate=r,a.pcmData=t,a.pcmPos=0,a.inputTime=Date.now(),a.schedule()},schedule:function(){var t=this,e=t.set,r=Math.floor(1e3/e.fps);t.timer||(t.timer=setInterval(function(){t.schedule()},r));var a=Date.now(),i=t.drawTime||0;if(a-t.inputTime>e.stripeFallDuration+500)return clearInterval(t.timer),void(t.timer=0);if(!(a-i<r)){t.drawTime=a;for(var o=t.fft.bufferSize,l=t.pcmData,n=t.pcmPos,h=new Int16Array(o),s=0;s<o&&n<l.length;s++,n++)h[s]=l[n];t.pcmPos=n;var f=t.fft.transform(h);t.draw(f,t.sampleRate)}},draw:function(t,e){var r=this,a=r.set,i=r.ctx,o=a.scale,l=a.width*o,n=a.height*o,h=a.lineCount,s=r.fft.bufferSize,f=[],d=e>>1,p=s>>1;2e4<d&&(p-=(d-2e4)/(d/p));for(var c=0;c<=h;c++)f[c]=Math.floor(.5+Math.pow(p,c/h)),0<c&&f[c]<=f[c-1]&&(f[c]=f[c-1]+1);var u=a.position,v=Math.abs(a.position),w=1==u?0:n,g=n;v<1&&(w=g/=2,g=Math.floor(g*(1+v)),w=Math.floor(0<u?w*(1-v):w*(1+v)));var m=r.lastH,M=r.stripesH,b=Math.ceil(g/(a.fallDuration/(1e3/a.fps))),C=Math.ceil(g/(a.stripeFallDuration/(1e3/a.fps))),y=a.stripeMargin*o,S=1<<(Math.round(Math.log(s)/Math.log(2)+3)<<1),H=Math.log(S)/Math.log(10),D=20*Math.log(32767)/Math.log(10);for(c=0;c<h;c++){for(var R=0,x=f[c],F=f[c+1];x<F;x++)R=Math.max(R,Math.abs(t[x]));var L=S<R?Math.floor(17*(Math.log(R)/Math.log(10)-H)):0,T=g*Math.min(L/D,1);m[c]=(m[c]||0)-b,T<m[c]&&(T=m[c]),T<0&&(T=0),m[c]=T;var B=M[c]||0;if(B<T)M[c]=T+y;else{var j=B-C;j<0&&(j=0),M[c]=j}}i.clearRect(0,0,l,n);var E=r.genLinear(i,a.linear,w,w-g),q=r.genLinear(i,a.linear,w,w+g);i.shadowBlur=a.shadowBlur*o,i.shadowColor=a.shadowColor;var z=a.lineWidth*o;l<z*h+(h+1)*o&&(z=Math.floor((l-(h+1)*o)/h));for(var I=(l-h*z)/(h+1),P=a.minHeight*o,W=(c=0,0);c<h;c++)W+=I,A=Math.floor(W),T=Math.max(m[c],P),0!=w&&(G=w-T,i.fillStyle=E,i.fillRect(A,G,z,T)),w!=n&&(i.fillStyle=q,i.fillRect(A,w,z,T)),W+=z;if(a.stripeEnable){var k=a.stripeShadowBlur;i.shadowBlur=(-1==k?a.shadowBlur:k)*o,i.shadowColor=a.stripeShadowColor||a.shadowColor;var A,G,V=a.stripeHeight*o;for(c=0,W=0;c<h;c++)W+=I,A=Math.floor(W),T=M[c],0!=w&&((G=w-T-V)<0&&(G=0),i.fillStyle=a.stripeColor||E,i.fillRect(A,G,z,V)),w!=n&&(n<(G=w+T)+V&&(G=n-V),i.fillStyle=a.stripeColor||q,i.fillRect(A,G,z,V)),W+=z}a.onDraw(t)}},Recorder.FrequencyHistogramView=t}();