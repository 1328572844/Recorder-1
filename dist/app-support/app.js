/*
录音
https://github.com/xiangyuecn/Recorder
src: app-support/app.js,app-support/app-ios-weixin-support.js,app-support/app-native-support.js
*/
!function(){"use strict";var t=/MicroMessenger/i.test(navigator.userAgent),e=window.RecordAppBaseFolder||"/Recorder/dist/",n=window.OnRecordAppInstalled,u=[{Key:"Native",Support:function(e){l.AlwaysAppUseJS?e(!1):o.Config.IsApp(e)},Config:{IsApp:function(e){e(!1)},JsBridgeRequestPermission:function(e,t){t("JsBridgeRequestPermission未实现")},JsBridgeStart:function(e,t,n){n("JsBridgeStart未实现")},JsBridgeStop:function(e,t){t("JsBridgeStop未实现")},paths:[{url:e+"app-support/app-native-support.js",check:function(){return!o.IsInit}}]},ExtendDefault:!0},{Key:"IOS-Weixin",Support:function(e){l.AlwaysUseWeixinJS||!Recorder.Support()?e(t):e(!1)},Config:{WxReady:function(e){e(null,"未实现IOS-Weixin.Config.WxReady")},DownWxMedia:function(e,t,n){n("下载素材接口DownWxMedia未实现")},paths:[{url:e+"app-support/app-ios-weixin-support.js",check:function(){return!r.IsInit}},{url:e+"engine/beta-amr.js",check:function(){return!Recorder.prototype.amr}}]},ExtendDefault:!0},{Key:"Default",Support:function(e){e(!0)},Config:{paths:[{url:e+"recorder-core.js",check:function(){return!window.Recorder}},{url:e+"engine/mp3.js",check:function(){return!Recorder.prototype.mp3}}]}}],o=u[0],r=u[1],f=u[2];f.RequestPermission=function(e,t){var n=Recorder();n.open(function(){n.close(),e()},t)},f.Start=function(e,t,n){var o=l.__Rec;null!=o&&o.close(),l.__Rec=o=Recorder({type:e.type,sampleRate:e.sampleRate,bitRate:e.bitRate,onProcess:function(e,t,n,o){l.ReceivePCM(e[e.length-1],t,n,o)}}),o.appSet=e,o.open(function(){o.start(),t()},function(e){n(e)})},f.Stop=function(n,t){var o=l.__Rec;if(o){var r=function(){for(var e in o.close(),o.set)o.appSet[e]=o.set[e];l.__Rec=null};o.stop(function(e,t){r(),n(e,t)},function(e){r(),t(e)})}else t("未开始录音")};var l={LM:"2019-4-23 14:51:14",Current:0,IsWx:t,BaseFolder:e,AlwaysUseWeixinJS:!1,AlwaysAppUseJS:!1,Platforms:{Native:o,Weixin:r,Default:f},Js:function(r,i,s,e){var a=(e=e||window).document,c=function(e){if(e>=r.length)i();else{var t=r[e],n=t.url;if(!1!==t.check()){var o=a.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",n),o.onload=function(){c(e+1)},o.onerror=function(e){s("请求失败:"+(e.message||"-")+"，"+n)},a.body.appendChild(o)}else c(e+1)}};c(0)},ReceivePCM:function(e,t,n,o){l.OnProcess&&l.OnProcess([e],t,n,o)},Install:function(n,o){var r=l.__reqs||(l.__reqs=[]);r.push({s:n,f:o}),n=function(){i("s",arguments)},o=function(e,t){i("f",arguments)};var i=function(e,t){for(var n=0;n<r.length;n++)r[n][e].apply(null,t);r.length=0};if(!(1<r.length)){var s=0,a=function(t,e){if(t.IsInit)e();else{var n=t.Config;l.Js(n.paths,function(){t.IsInit=!0,e()},function(e){e="初始化js库失败："+e,console.log(e,t),o(e)})}},c=function(t){if(t)l.Current=t,n();else{var e=function(){t.Support(function(e){e?a(t,function(){c(t)}):(s++,c())})};(t=u[s]).ExtendDefault?a(f,e):e()}};c(l.Current)}},RequestPermission:function(t,n){l.Install(function(){var e=l.Current;console.log("开始请求"+e.Key+"录音权限"),e.RequestPermission(function(){console.log("录音权限请求成功"),t()},function(e,t){console.log("录音权限请求失败："+e+",isUserNotAllow:"+t),n(e,t)})},function(e){console.log("Install失败",e),n(e)})},Start:function(e,t,n){var o=l.Current;if(o){e||(e={});var r={type:"mp3",sampleRate:16e3,bitRate:16};for(var i in r)e[i]||(e[i]=r[i]);o.Start(e,function(){console.log("开始录音",e),t()},function(e){console.log("开始录音失败："+e),n(e)})}else n("需先调用RequestPermission")},Stop:function(n,t){var e=l.Current;e?e.Stop(function(e,t){console.log("结束录音"+e.size+"b "+t+"ms",e),n(e,t)},function(e){console.log("结束录音失败："+e),t(e)}):t("需先调用RequestPermission")}};window.RecordApp=l,n&&n()}(),function(){"use strict";var r=RecordApp.Platforms.Weixin,g=r.Config;r.IsInit=!0;var i,s,a={};r.RequestPermission=function(n,o){g.WxReady(function(e,t){a.wx=null,t?o("微信JsSDK准备失败："+t):(a.wx=e,n())})};var c=function(t){i=s=0,a.wx.stopRecord({success:function(){t()},fail:function(e){t("无法结束："+e.errMsg)}})};r.Start=function(e,t,n){var o=a.wx;if(o){if(s)return console.log("正在录音，正在结束后重试"),void c(function(){setTimeout(function(){r.Start(e,t,n)},300)});if(i)return console.log("等待上次wx.startRecord回调后重试"),void setTimeout(function(){r.Start(e,t,n)},600);s=0,i=1,o.startRecord({success:function(){s=1,i=0,a.startTime=Date.now(),a.start=e,t()},fail:function(e){i=0,n("无法录音："+e.errMsg),c()}}),a.timeout=[],a.err="",o.onVoiceRecordEnd({complete:function(e){var t=Date.now();a.timeout.push({res:e,duration:t-a.startTime,time:t}),console.log("微信录音超时，正在重启..."),o.startRecord({success:function(){a.startTime=Date.now(),console.log("已接续录音,中断"+(Date.now()-t)+"ms")},fail:function(e){var t="无法接续录音："+e.errMsg;console.error(t,e),a.err=t}})}})}else n("请先调用RequestPermission")},r.Stop=function(l,t){var p=function(e){t("录音失败："+(e.errMsg||e))},d=a.start;if(d){a.start=null;var v={list:[]};d.DownWxMediaData=v;var u=function(){var r=v.list,e=r[0];if(e.duration){for(var t=atob(e.data),n=t.length,o=new Uint8Array(n);n--;)o[n]=t.charCodeAt(n);var i=new Blob([o.buffer],{type:e.mime});l(i,e.duration)}else{var s=[],a=0,c=0,u=0,f=function(){if(u||(u=Date.now()),c>=r.length)return v.decodeTime=Date.now()-u,void function(){a||(a=Date.now());for(var e=[],t=0;t<s.length;t++)for(var n=s[t],o=0;o<n.length;o++)e.push(n[o]);var r=Recorder(d).mock(e,8e3);r.stop(function(e,t){for(var n in v.encodeTime=Date.now()-a,r.set)d[n]=r.set[n];l(e,t)},p)}();var e=r[c];e.duration=m[c].duration,e.isAmr=!0;for(var t=atob(e.data),n=t.length,o=new Uint8Array(n);n--;)o[n]=t.charCodeAt(n);Recorder.AMR.decode(o,function(e){s.push(e),c++,f()},function(e){p("AMR音频"+(c+1)+"无法解码:"+e)})};Recorder.AMR?f():p("未加载AMR转换引擎")}},f=[],n=function(){for(var t=[],e=0;e<m.length;e++)t.push(m[e].res.localId);console.log("结束录音共"+t.length+"段，开始上传下载");var n=0,o=0,r=function(){v.downTime=Date.now()-o,u()},i=function(){if(o||(o=Date.now()),n>=f.length)r();else{var e=f[n];g.DownWxMedia({mediaId:e,transform_mediaIds:f.join(","),transform_type:d.type,transform_bitRate:d.bitRate,transform_sampleRate:d.sampleRate},function(e){v.list.push(e),e.duration?r():/amr/i.test(e.mime)?(n++,i()):p("微信服务器返回了未知音频类型："+e.mime)},function(e){p("下载音频失败："+e)})}},s=0,a=function(){if(s>=t.length)return v.uploadTime=Date.now()-c,void i();var e=t[s];console.log("微信录音片段"+s+" wx.playVoice({localId:'"+e+"'})"),wx.uploadVoice({localId:e,isShowProgressTips:0,fail:p,success:function(e){var t=e.serverId;console.log("serverId:"+t),f.push(t),s++,a()}})},c=Date.now();a()},m=a.timeout;if(a.err)return console.error(a.err,m),void p("录制失败，已录制"+m.length+"分钟，但后面出错："+a.err);if(m.length&&Date.now()-m[m.length-1].time<900)return c(),void n();s=0,a.wx.stopRecord({fail:p,success:function(e){var t=Date.now();m.push({res:e,duration:t-a.startTime,time:t}),n()}})}else p("未开始录音")}}(),function(){"use strict";var l=RecordApp,e=l.Platforms.Native,o=e.Config;e.IsInit=!0;var p=window.NativeRecordReceivePCM=window.top.NativeRecordReceivePCM=function(e,t){if(p.pcm){for(var n,o,r=atob(e),i=r.length,s=new Int16Array(i/2),a=0,c=0,u=0;u+2<=i;c++,u+=2)n=(r.charCodeAt(u)|r.charCodeAt(u+1)<<8)<<16>>16,s[c]=n,a+=Math.abs(n);p.sampleRate=t,p.pcm.push(s),p.recSize+=s.length,o=(a/=s.length)<1251?Math.round(a/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(a/1e4)/Math.log(10)))));var f=Math.round(p.recSize/t*1e3);l.ReceivePCM(s,o,f,t)}else console.error("未开始录音，但收到Native PCM数据")};e.RequestPermission=function(e,t){o.JsBridgeRequestPermission(e,t)},e.Start=function(e,t,n){p.param=e,p.pcm=[],p.recSize=0,o.JsBridgeStart(e,t,n)},e.Stop=function(c,u){o.JsBridgeStop(function(){var e=p.pcm;if(p.pcm=null,e){for(var t=new Int16Array(p.recSize),n=0,o=0;o<e.length;o++)for(var r=e[o],i=0;i<r.length;i++)t[n++]=r[i];console.log("rec encode start: rec:"+t.length+" src:"+p.sampleRate+" set:"+JSON.stringify(p.param));var s=Recorder(p.param).mock(t,p.sampleRate),a=function(){for(var e in s.set)p.param[e]=s.set[e]};s.stop(function(e,t){console.log("rec encode end"),a(),c(e,t)},function(e){a(),u(e)})}else u("未开始录音")},u)}}();