/*
录音
https://github.com/xiangyuecn/Recorder
src: recorder-core.js
*/
!function(a){"use strict";a.RecorderLM="2019-8-17 12:12:03";var r=function(){};function v(e){return new t(e)}function t(e){var t={type:"mp3",bitRate:16,sampleRate:16e3,bufferSize:4096,onProcess:r};for(var a in e)t[a]=e[a];this.set=t}v.IsOpen=function(){var e=v.Stream;if(e){var t=e.getTracks();if(0<t.length)return"live"==t[0].readyState}return!1},v.Support=function(){var e=a.AudioContext;if(e||(e=a.webkitAudioContext),!e)return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(v.Scope=t,v.Ctx&&"closed"!=v.Ctx.state||(v.Ctx=new e),!0)},v.SampleData=function(e,t,a,n){n||(n={});for(var o=n.index||0,r=n.offset||0,s=0,i=o;i<e.length;i++)s+=e[i].length;s=Math.max(0,s-Math.floor(r));var c=t/a;1<c?s=Math.floor(s/c):(c=1,a=t);for(var p=new Int16Array(s),f=0,u=e.length;o<u;o++){for(var l=e[o],m=(i=r,l.length);i<m;){var h=Math.floor(i),d=Math.ceil(i),v=i-h;p[f]=l[h]+(l[d]-l[h])*v,f++,i+=c}r=i-m}return{index:o,offset:r,sampleRate:a,data:p}},v.prototype=t.prototype={open:function(t,n){if(t=t||r,n=n||r,v.IsOpen())t();else if(v.Support()){var e=function(e){v.Stream=e,setTimeout(function(){v.IsOpen()?t():n("录音功能无效：无音频流")},100)},a=function(e){var t=e.name||e.message||"";console.error(e);var a=/Permission|Allow/i.test(t);n(a?"用户拒绝了录音权限":"无法录音："+t,a)},o=v.Scope.getUserMedia({audio:!0},e,a);o&&o.then&&o.then(e).catch(a)}else n("此浏览器不支持录音",!1)},close:function(e){e=e||r;this._stop();var t=v.Stream;if(t)for(var a=t.getTracks(),n=0;n<a.length;n++)a[n].stop();v.Stream=0,e()},start:function(){var e=this,t=e.set,a=v.Ctx;if(e.buffers=[],e.recSize=0,e._stop(),e.state=0,v.IsOpen()){if(console.log("["+Date.now()+"]Start"),t.sampleRate=Math.min(a.sampleRate,t.sampleRate),e.srcSampleRate=a.sampleRate,e.isMock=0,e.engineCtx=0,e[t.type+"_start"]){var n=e.engineCtx=e[t.type+"_start"](t);n&&(n.pcmDatas=[],n.pcmSize=0)}"suspended"==a.state?a.resume().then(function(){console.log("ctx resume"),e._start()}):e._start()}},_start:function(){var m=this,h=m.set,d=m.engineCtx,e=v.Ctx,t=m.media=e.createMediaStreamSource(v.Stream),a=m.process=(e.createScriptProcessor||e.createJavaScriptNode).call(e,h.bufferSize,1,1);a.onaudioprocess=function(e){if(1==m.state){var t=e.inputBuffer.getChannelData(0),a=t.length;m.recSize+=a;for(var n,o=m.buffers,r=new Int16Array(a),s=0,i=0;i<a;i++){var c=Math.max(-1,Math.min(1,t[i]));c=c<0?32768*c:32767*c,r[i]=c,s+=Math.abs(c)}o.push(r),n=(s/=a)<1251?Math.round(s/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(s/1e4)/Math.log(10)))));var p=m.srcSampleRate,f=m.recSize;if(d){var u=v.SampleData(o,p,h.sampleRate,d.chunkInfo);d.chunkInfo=u,d.pcmSize+=u.data.length,f=d.pcmSize,(o=d.pcmDatas).push(u.data),p=u.sampleRate,m[h.type+"_encode"](d,u.data)}var l=Math.round(f/p*1e3);h.onProcess(o,n,l,p)}},t.connect(a),a.connect(e.destination),m.state=1},_stop:function(e){var t=this,a=t.set;t.state&&(t.state=0,t.media.disconnect(),t.process.disconnect()),!e&&t[a.type+"_stop"]&&(t[a.type+"_stop"](t.engineCtx),t.engineCtx=0)},pause:function(e){this.state&&(this.state=e||2)},resume:function(){this.pause(1)},mock:function(e,t){var a=this;return a._stop(),a.isMock=1,a.buffers=[e],a.recSize=e.length,a.srcSampleRate=t,a},stop:function(a,t){console.log("["+Date.now()+"]Stop");var n,o=this,r=o.set,s=function(e){t&&t(e),o._stop()},i=function(e,t){console.log("["+Date.now()+"]End",t,"编码耗时:"+(Date.now()-n),e),e.size<500?s("生成的"+r.type+"无效"):(a&&a(e,t),o._stop())};if(!o.isMock){if(!o.state)return void s("未开始录音");o._stop(!0)}var e=o.recSize;if(e)if(o[r.type]){var c=o.engineCtx;if(o[r.type+"_complete"]&&c){c.pcmDatas;var p=Math.round(c.pcmSize/r.sampleRate*1e3);return n=Date.now(),void o[r.type+"_complete"](c,function(e){i(e,p)},s)}n=Date.now();var f=v.SampleData(o.buffers,o.srcSampleRate,r.sampleRate);r.sampleRate=f.sampleRate;var u=f.data;p=Math.round(u.length/r.sampleRate*1e3);console.log("采样"+e+"->"+u.length+" 花:"+(Date.now()-n)+"ms"),setTimeout(function(){n=Date.now(),o[r.type](u,function(e){i(e,p)},function(e){s(e)})})}else s("未加载"+r.type+"编码器");else s("未采集到录音")}},a.Recorder=v}(window);